<!DOCTYPE html>
<html lang="zh-hart" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>訂單明細</title>

    <!-- import bootstrap 5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

    <!-- import font-style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">

    <!-- import css stylesheet -->

    <!-- import jquery-3.6.0 -->
    <script src="http://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- import icon -->
    <script src="https://kit.fontawesome.com/b5ef6b60f3.js" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qs/6.11.0/qs.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        [v-clock] {
            display: none;
        }
    </style>
</head>

<body>


<main>

    <article style="height: 1000px">

        <div id="app" class="container" v-cloak>

            <div class="py-5 text-center">
                <h2>確認您的訂單</h2>
                <p class="lead">請確認您的訂單無誤並且填入正確的資料</p>
            </div>

            <div class="row">
                <div class="col-md-4 order-md-2 mb-4">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">您的商品</span>
                        <span class="badge badge-secondary badge-pill">3</span>
                    </h4>

                    <div class="sticky-top">
                        <ul class="list-group mb-3">
                            <li v-for="orderItems in orderItems"
                                class="list-group-item d-flex justify-content-between lh-condensed">
                                <div>
                                    <h6 class="my-0">{{ orderItems.itemName }}×{{ orderItems.cdAmount }}</h6>
                                </div>
                                <span class="text-muted">${{ orderItems.itemPrice }}</span>
                            </li>

                            <li class="list-group-item d-flex justify-content-between bg-light">
                                <div class="text-success">
                                    <h6 class="my-0">{{ couponSelected }}</h6>
                                </div>
                                <span class="text-success">-${{ couponVal }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total (NT$)</span>
                                <strong>${{ finalPrice }}</strong>
                            </li>
                        </ul>

                        <form>
                            <div class="from-group">
                                <select v-model="couponSelected" v-for="(coupon, index) in coupon"
                                        @change="couponSelectChange(coupon, index)"
                                        class="form-select"
                                        :key="coupon.COUPON_ID">
                                    <option value="" disabled selected>使用折價券</option>
                                    <option style="display: none">{{ index }}</option>
                                    <option>
                                        {{ coupon.COUPON_NAR }}
                                    </option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <br>

                <div class="col-md-6 container bg-default">

                    <!--                    <h4 class="mb-4"> 請選擇寄件方式 </h4>-->
                    <!--                    <div class="form-check">-->
                    <!--                        <input type="radio" class="form-check-input" id="store" v-model="orderSend" value="1"-->
                    <!--                               name="orderSend" checked required>-->
                    <!--                        <label for="store" class="form-check-label"> 超商取貨 </label>-->
                    <!--                    </div>-->
                    <!--                    <div class="form-check">-->
                    <!--                        <input type="radio" class="form-check-input" id="express" v-model="orderSend" value="0"-->
                    <!--                               name="orderSend" required>-->
                    <!--                        <label for="express" class="form-check-label"> 宅配到家 </label>-->
                    <!--                    </div>-->

                    <div class="row mt-4">
                        <!--                        <h4 class="mb-4"> 確認信息 </h4>-->
                        <div class="col-md-6 form-group">
                            <br>
                            <label for="name"> 收件人姓名 </label>
                            <input type="text" class="form-control" id="name" v-model="orderName"
                                   placeholder="請輸入本名" required>
                            <div class="invalid-feedback">
                                收件人姓名為必填項目
                            </div>
                        </div>

                        <div class="col-md-6 form-group">
                            <br>
                            <label for="phone"> 行動電話 </label>
                            <input type="text" class="form-control" v-model="phone" id="phone"
                                   placeholder="ex. 0900-000-000"
                                   required>
                            <div class="invalid-feedback">
                                收件人電話為必填項目
                            </div>
                        </div>
                    </div>
                    <br>

                    <div>收件地址</div>


                    <div class="form-group">
                        <input type="text" class="form-control" id="inputAddress" v-model="address" name="address"
                               placeholder="請輸入地址" required>
                    </div>
                    <br>
                    <div class="invalid-feedback">
                        寄件地址為必要項目
                    </div>

                    <label>其他備註</label>
                    <div class="input-group">
                        <textarea class="form-control" id="other" v-model="orderOther" name="orderOther"></textarea>
                    </div>


                    <hr>
                    <!--                    <h4 class="mb-4"> 付款方式 </h4>-->
                    <!--                    <div class="form-check">-->
                    <!--                        <input type="radio" class="form-check-input" id="credit" v-model="orderPaying" value="2"-->
                    <!--                               name="payment-method" checked required>-->
                    <!--                        <label for="credit" class="form-check-label"> 信用卡支付 </label>-->
                    <!--                    </div>-->
                    <!--                    <div class="form-check">-->
                    <!--                        <input type="radio" class="form-check-input" id="ATM" v-model="orderPaying" value="1"-->
                    <!--                               name="payment-method" required>-->
                    <!--                        <label for="ATM" class="form-check-label"> ATM 轉帳 </label>-->
                    <!--                    </div>-->

                    <button class="btn btn-primary bt-lg btn-block " id="nextStep" @click="nextStep()"> 確認無誤
                    </button>

                    <div id="orderForm"></div>

                </div>
            </div>
        </div>

    </article>

</main>

<footer>

    <div class="container">

    </div>

</footer>


<!-- import bootstrap 5.2.1 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>


<!-- import vue.js  -->
<script src="https://unpkg.com/vue@3"></script>
<script src="https://unpkg.com/vue-router@4"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>

    let vm = Vue.createApp({
        data() {
            return {
                couponSelected: '',
                couponVal: '0',
                couponId: '0',
                action: 'new_Order',
                memberId: '',
                coupon: [],
                orderItems: [
                    {
                        "itemId": 1,
                        "itemName": "[Zeniter先立特] 頂級無穀幼母犬1.2kg 幼母犬糧 狗飼料",
                        "cdAmount": 2,
                        "itemPrice": 499
                    },
                    {
                        "itemId": 3,
                        "itemName": "Petkit 小佩智能感應式除臭貓砂盆",
                        "cdAmount": 1,
                        "itemPrice": 2380
                    },
                    {
                        "itemId": 7,
                        "itemName": "Petkit 小佩 寵物智能去味器-除臭首推",
                        "cdAmount": 1,
                        "itemPrice": 790
                    },
                    {
                        "itemId": 11,
                        "itemName": "『爆玩新品』PIDAN 電動小雪怪-翻滾玩具",
                        "cdAmount": 1,
                        "itemPrice": 160
                    }
                ],
                orderPaying: 2,
                orderSend: 0,
                orderOther: '',
                orderName: '',
                orderStatus: '',
                phone: '',
                address: '',
            }
        },
        beforeCreate() {
            let member = sessionStorage.getItem('mem-info');
            if (!member) {
                Swal.fire({
                    icon: 'error',
                    title: '你還沒登入喔!',
                })
                setTimeout(function () {
                    window.location.assign('/CGA104G1/frontend/mem/login.jsp')
                }, 2000)
            }
            let memberId = JSON.parse(member).memberId
            let qs = Qs;
            axios.post('/CGA104G1/MemberCouponServlet', qs.stringify({
                memberId: memberId
            }))
                .then(res => {
                    console.log(res);
                    this.coupon = res.data;
                })
                .catch(err => {
                    console.log(err);
                })
        },
        mounted() {
            let member = sessionStorage.getItem('mem-info');
            this.memberId = JSON.parse(member).memberId
            // let cart = sessionStorage.getItem('part')
            // this.orderItems = JSON.stringify(cart)
        },
        computed: {
            finalPrice: function () {
                let total = 0;
                let finalPrice = 0;
                for (let i in this.orderItems) {
                    var attr = this.orderItems[i];
                    total += parseInt((attr.itemPrice * attr.cdAmount));
                }
                finalPrice = total - this.couponVal;
                return finalPrice;
            }
        },
        methods: {
            nextStep: function () {
                const swalWithBootstrapButtons = Swal.mixin({
                    customClass: {
                        confirmButton: 'btn btn-success',
                        cancelButton: 'btn btn-warning'
                    },
                    buttonsStyling: false
                })

                swalWithBootstrapButtons.fire({
                    title: '確認要送出訂單嗎?',
                    text: "付款完成後將會收到通知郵件",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '確認送出',
                    cancelButtonText: '再次確認',
                    reverseButtons: true

                }).then((result) => {
                    if (result.isConfirmed) {
                        var qs = Qs;
                        axios.post('/CGA104G1/orderBuy/newOrder.do', qs.stringify({
                            memberId: this.memberId,
                            action: this.action,
                            couponId: this.couponId,
                            orderPaying: this.orderPaying,
                            orderSend: this.orderSend,
                            receiverName: this.orderName,
                            orderOther: this.orderOther,
                            receiverAddress: this.address,
                            receiverPhone: this.phone,
                            dataArr: JSON.stringify(this.orderItems)
                        }))
                            .then(res => {
                                console.log(res);
                                Swal.fire({
                                    title: '交易送出中請稍後~',
                                    html: 'data uploading',// add html attribute if you want or remove
                                    allowOutsideClick: false
                                })
                                $("#orderForm").html(res.data)
                            })
                            .catch(err => {
                                console.log(err);
                            })
                    } else if (
                        /* Read more about handling dismissals below */
                        result.dismiss === Swal.DismissReason.cancel
                    ) {
                        swalWithBootstrapButtons.fire(
                            '我們還未送出您的訂單',
                            '您的主人在注視著你呢~ :)',
                            'warning'
                        )
                    }
                })
            },
            couponSelectChange: function (coupon, index) {
                var qs = Qs;
                axios.post('/CGA104G1/getCouponValServlet', qs.stringify({
                    couponId: this.coupon[index].COUPON_ID
                }))
                    .then(res => {
                        console.log(res)
                        this.couponVal = res.data
                        this.couponId = this.coupon[index].COUPON_ID
                    })
                    .catch(err => {
                        console.log(err)
                    })
            }
        }
    });
    vm.mount('#app');
</script>


</body>
<!--  NavBar  -->
<script src="../../resources/static/js/navbar.js"></script>
<!--  Footer  -->
<script src="../../resources/static/js/footer.js"></script>

</html>
<script>

</script>
